#' geneEnrichment
#'
#' Function to calculate fold change enrichment in a set of snv calls correcting for gene length
#' @param  gene_lengths File containing all genes and their lengths (as generated by 'script/genomefeatures.pl')[Default 'data/gene_lengths.txt']
#' @keywords enrichment
#' @import dplyr
#' @return dplyr
#' @export A data frame with FC scores for all genes seen at least n times in snv data


geneEnrichment <- function(gene_lengths="data/gene_lengths.txt", n=2){
  gene_lengths<-read.delim(gene_lengths, header = T)
  data<-getData()
  data<-filter(data, gene != "intergenic")
  head(arrange(gene_lengths,desc(length)))
  
  snv_count<-nrow(data)
  
  hit_genes<-table(data$gene)
  genes<-setNames(as.list(gene_lengths$length), gene_lengths$gene)
  
  fun <- function(g) {
    genefraction<-genes[[g]]/137547960
    gene_expect<-snv_count*(genefraction)
    gene_expect<-round(gene_expect,digits=3)
    fc<-hit_genes[g]/gene_expect
    fc<-round(fc,digits=1)
    list(gene = g, observed = hit_genes[g], expected = gene_expect, fc = fc)
  }
  
  enriched<-lapply(levels(data$gene), fun)
  enriched<-do.call(rbind, enriched)
  genesFC<-as.data.frame(enriched)
  genesFC<-filter(genesFC, observed > n)
  genesFC<-arrange(genesFC,desc(as.integer(fc)))
  return(genesFC)
}
